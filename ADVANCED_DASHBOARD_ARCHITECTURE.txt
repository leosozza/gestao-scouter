# Advanced Dashboard System - Architecture Diagram

```
┌─────────────────────────────────────────────────────────────────────────┐
│                        ADVANCED DASHBOARD SYSTEM                         │
│                     (14 Chart Types + Custom Formulas)                   │
└─────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                              USER INTERFACE                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │           AdvancedDashboard.tsx (Main Page)                    │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Header: Dashboard Controls                          │     │    │
│  │  │  - New Dashboard | Save | Load | Options             │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Dashboard Info Card                                 │     │    │
│  │  │  - Name | Description | Mode Badge | Widget Count    │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  React Grid Layout (12 columns)                      │     │    │
│  │  │  ┌────────┐  ┌────────┐  ┌────────┐                │     │    │
│  │  │  │Widget 1│  │Widget 2│  │Widget 3│  [Drag & Drop] │     │    │
│  │  │  │ (4x3)  │  │ (4x3)  │  │ (4x3)  │  [Resize]      │     │    │
│  │  │  └────────┘  └────────┘  └────────┘                │     │    │
│  │  │  ┌──────────────┐  ┌──────────────┐                │     │    │
│  │  │  │  Widget 4    │  │  Widget 5    │                │     │    │
│  │  │  │  (6x4)       │  │  (6x4)       │                │     │    │
│  │  │  └──────────────┘  └──────────────┘                │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                         WIDGET ARCHITECTURE                               │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  DynamicWidget.tsx                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Widget Header                                       │     │    │
│  │  │  - Title | Icon | Edit/Delete Buttons               │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Data Fetching Layer (React Query)                   │     │    │
│  │  │  - Query Key: [widget-id, config]                    │     │    │
│  │  │  - Auto-refresh: 60s                                 │     │    │
│  │  │  - Cache: 5 minutes                                  │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Chart Renderer (Switch on chartType)               │     │    │
│  │  │  ├─ table      → TableView                           │     │    │
│  │  │  ├─ bar        → ApexBarChart                        │     │    │
│  │  │  ├─ line       → ApexLineChart                       │     │    │
│  │  │  ├─ area       → ApexAreaChart                       │     │    │
│  │  │  ├─ pie        → ApexPieChart                        │     │    │
│  │  │  ├─ donut      → ApexDonutChart                      │     │    │
│  │  │  ├─ kpi_card   → KPIView                             │     │    │
│  │  │  ├─ radar      → RadarChart                          │     │    │
│  │  │  ├─ funnel     → FunnelChart                         │     │    │
│  │  │  ├─ gauge      → GaugeChart                          │     │    │
│  │  │  ├─ heatmap    → HeatmapChart                        │     │    │
│  │  │  ├─ pivot      → PivotTable                          │     │    │
│  │  │  ├─ scatter    → ScatterChart ⭐ NEW                 │     │    │
│  │  │  └─ treemap    → TreemapChart ⭐ NEW                 │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                       WIDGET CONFIGURATION                                │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  WidgetConfigModal.tsx                                         │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  [Basic] [Visual] [Formula] ⭐ [Advanced]           │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  TAB 1: Basic Configuration                                    │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │ • Title & Subtitle                                   │     │    │
│  │  │ • Dimension Selection (8 options)                    │     │    │
│  │  │ • Metrics Selection (11 options)                     │     │    │
│  │  │ • Chart Type (14 options) ⭐                         │     │    │
│  │  │ • Date Grouping (day/week/month/quarter/year)        │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  TAB 2: Visual Configuration                                   │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │ • Color Scheme (7 palettes)                          │     │    │
│  │  │ • Legend Position & Visibility                       │     │    │
│  │  │ • Grid & Labels Toggle                               │     │    │
│  │  │ • Font Size & Styling                                │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  TAB 3: Formula Configuration ⭐ NEW                           │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │ • Create/Edit Custom Formula                         │     │    │
│  │  │ • Formula Validation (Real-time)                     │     │    │
│  │  │ • Templates & Examples                               │     │    │
│  │  │ • Available Functions List                           │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  TAB 4: Advanced Options                                       │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │ • Result Limit (Top N)                               │     │    │
│  │  │ • Sort Options                                       │     │    │
│  │  │ • Refresh Interval                                   │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                        FORMULA ENGINE ⭐                                  │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  FormulaBuilder.tsx                                            │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  LEFT PANEL: Editor                                  │     │    │
│  │  │  ┌────────────────────────────────────────────┐     │     │    │
│  │  │  │ Formula Name                               │     │     │    │
│  │  │  │ ┌────────────────────────────────────┐    │     │     │    │
│  │  │  │ │ PERCENT(COUNT_DISTINCT(id),        │    │     │     │    │
│  │  │  │ │         COUNT(*))                  │    │     │     │    │
│  │  │  │ └────────────────────────────────────┘    │     │     │    │
│  │  │  │ ✓ Formula válida                           │     │     │    │
│  │  │  │                                            │     │     │    │
│  │  │  │ Description                                │     │     │    │
│  │  │  │ Templates: [Taxa Conversão▼]               │     │     │    │
│  │  │  └────────────────────────────────────────────┘     │     │    │
│  │  │                                                      │     │    │
│  │  │  RIGHT PANEL: Reference                              │     │    │
│  │  │  ┌────────────────────────────────────────────┐     │     │    │
│  │  │  │ Available Functions:                       │     │     │    │
│  │  │  │ [SUM] [AVG] [COUNT] [COUNT_DISTINCT]       │     │     │    │
│  │  │  │ [MIN] [MAX] [PERCENT] [DIVIDE]             │     │     │    │
│  │  │  │ [MULTIPLY] [ADD] [SUBTRACT]                │     │     │    │
│  │  │  │                                            │     │     │    │
│  │  │  │ Available Fields:                          │     │     │    │
│  │  │  │ [id] [valor_ficha] [scouter] [projeto]    │     │     │    │
│  │  │  │                                            │     │     │    │
│  │  │  │ Tips & Examples                            │     │     │    │
│  │  │  └────────────────────────────────────────────┘     │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  formulaEngine.ts                                              │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  parseFormula(expression)                            │     │    │
│  │  │    ↓                                                 │     │    │
│  │  │  FormulaExpression Tree                              │     │    │
│  │  │    ↓                                                 │     │    │
│  │  │  evaluateFormula(tree, data)                         │     │    │
│  │  │    ↓                                                 │     │    │
│  │  │  Result (number)                                     │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  │                                                                 │    │
│  │  Supported Functions:                                          │    │
│  │  • Aggregations: SUM, AVG, MIN, MAX, COUNT, COUNT_DISTINCT    │    │
│  │  • Math: ADD, SUBTRACT, MULTIPLY, DIVIDE                       │    │
│  │  • Advanced: PERCENT, IF                                       │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                          DATA FLOW                                        │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  User Action                                                              │
│      ↓                                                                    │
│  AdvancedDashboard State Update                                          │
│      ↓                                                                    │
│  React Grid Layout Change                                                │
│      ↓                                                                    │
│  Widget Layout Update                                                    │
│      ↓                                                                    │
│  DynamicWidget Re-render                                                 │
│      ↓                                                                    │
│  React Query Fetch                                                       │
│      ↓                                                                    │
│  dashboardQueryService                                                   │
│      ↓                                                                    │
│  Supabase Query                                                          │
│      ↓                                                                    │
│  Data Processing                                                         │
│      ↓                                                                    │
│  Custom Formula Evaluation (if defined)                                  │
│      ↓                                                                    │
│  Chart Component Render                                                  │
│      ↓                                                                    │
│  ApexCharts Display                                                      │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                       PERSISTENCE LAYER                                   │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  Supabase Database                                             │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  Table: dashboard_configs                            │     │    │
│  │  │  ┌────────────────────────────────────────────┐     │     │    │
│  │  │  │  id              UUID (PK)                 │     │     │    │
│  │  │  │  user_id         UUID (FK → auth.users)    │     │     │    │
│  │  │  │  name            TEXT                      │     │     │    │
│  │  │  │  description     TEXT                      │     │     │    │
│  │  │  │  widgets         JSONB ⭐                  │     │     │    │
│  │  │  │  layout          JSONB                     │     │     │    │
│  │  │  │  theme           JSONB                     │     │     │    │
│  │  │  │  is_default      BOOLEAN                   │     │     │    │
│  │  │  │  auto_refresh    BOOLEAN                   │     │     │    │
│  │  │  │  refresh_int     INTEGER                   │     │     │    │
│  │  │  │  created_at      TIMESTAMPTZ               │     │     │    │
│  │  │  │  updated_at      TIMESTAMPTZ               │     │     │    │
│  │  │  └────────────────────────────────────────────┘     │     │    │
│  │  │                                                      │     │    │
│  │  │  Indexes:                                            │     │    │
│  │  │  - idx_dashboard_configs_user_id                    │     │    │
│  │  │  - idx_dashboard_configs_is_default                 │     │    │
│  │  │                                                      │     │    │
│  │  │  RLS Policies:                                       │     │    │
│  │  │  - SELECT: auth.uid() = user_id                     │     │    │
│  │  │  - INSERT: auth.uid() = user_id                     │     │    │
│  │  │  - UPDATE: auth.uid() = user_id                     │     │    │
│  │  │  - DELETE: auth.uid() = user_id                     │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
│  ┌────────────────────────────────────────────────────────────────┐    │
│  │  useDashboardConfig Hook                                       │    │
│  │  ┌──────────────────────────────────────────────────────┐     │    │
│  │  │  - useQuery: Fetch all configs                       │     │    │
│  │  │  - useMutation: Save new config                      │     │    │
│  │  │  - useMutation: Update existing                      │     │    │
│  │  │  - useMutation: Delete config                        │     │    │
│  │  └──────────────────────────────────────────────────────┘     │    │
│  └────────────────────────────────────────────────────────────────┘    │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                      TECHNOLOGY STACK                                     │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  Frontend:                                                                │
│  • React 18 + TypeScript                                                 │
│  • Vite (Build tool)                                                     │
│  • react-grid-layout (Drag & Drop) ⭐                                    │
│  • ApexCharts + react-apexcharts (Charts) ⭐                             │
│  • TanStack React Query v5 (State management)                           │
│  • shadcn/ui + Radix UI (UI Components)                                 │
│  • Tailwind CSS (Styling)                                               │
│  • React Hook Form + Zod (Forms & Validation)                           │
│                                                                           │
│  Backend & Services:                                                     │
│  • Supabase (Database + Auth + Storage)                                 │
│  • PostgreSQL (via Supabase)                                            │
│                                                                           │
│  Development:                                                             │
│  • ESLint + TypeScript ESLint                                           │
│  • Prettier (Code formatting)                                           │
│  • Git (Version control)                                                │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

┌──────────────────────────────────────────────────────────────────────────┐
│                        KEY FEATURES                                       │
├──────────────────────────────────────────────────────────────────────────┤
│                                                                           │
│  ✅ 14 Chart Types (complete set)                                        │
│  ✅ Drag-and-drop layout (react-grid-layout)                             │
│  ✅ Custom formula system (11 functions)                                 │
│  ✅ Save/Load dashboard configurations                                   │
│  ✅ Export/Import JSON configs                                           │
│  ✅ Real-time validation                                                 │
│  ✅ Auto-refresh (60s interval)                                          │
│  ✅ Multiple color schemes (7 palettes)                                  │
│  ✅ Responsive design                                                    │
│  ✅ Widget duplication                                                   │
│  ✅ Edit/View mode toggle                                                │
│  ✅ Row-level security (RLS)                                             │
│                                                                           │
└──────────────────────────────────────────────────────────────────────────┘

Legend:
⭐ = New or Enhanced Feature
✅ = Implemented and Working
[...] = Interactive Component
```
